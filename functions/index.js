// generated by @ng-toolkit/serverless
'use strict';

const functions = require('firebase-functions');
const admin = require("firebase-admin");
const nodemailer = require('nodemailer');
admin.initializeApp(functions.config().firebase);

// const gmailEmail = functions.config().gmail.email;
// const gmailPassword = functions.config().gmail.password;
// SMTP_PORT=587
// SMTP_AUTH_USER=dotafreelancer@gmail.com
// SMTP_AUTH_PASSWORD=XXxx11@@
const mailTransport = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: 'dotafreelancer@gmail.com',
    pass: 'XXxx11@@',
  }
});


const sendNotification = functions.firestore
  .document('/user/{value}').onCreate(event => {
    console.log('ok');
    const data = event.data.data();
    let email = data.email;
    let name = data.name;
    if (email && name) {
      sendEmail(email, name);
    }

    const payload = {
      notification: {
        title: 'New Message',
        body: 'body',
        icon: "https://financial-manage.firebaseapp.com/assets/images/home.jpg",
        click_action: "https://financial-manage.firebaseapp.com/admin/"
      }
    };
    var fcmTokens = admin.firestore().collection('fcmTokens');
    return fcmTokens.get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          admin.messaging().sendToDevice(doc.data().token, payload).then(response => {
            // console.log("Send success")
          }).catch(function (error) {
            console.log("Error sending message:", error);
          });
        });
        return true;
      })
      .catch(err => {
        console.log('Error getting documents', err);
      });
  });

const APP_NAME = 'Cloud Storage for Firebase quickstart';

const sendWelcomeEmail = functions.auth.user().onCreate((user) => {
  // [END onCreateTrigger]
  // [START eventAttributes]
  const email = user.email; // The email of the user.
  const displayName = user.displayName; // The display name of the user.
  // [END eventAttributes]

  return sendEmail(email, 'displayName');
});

function sendEmail(email, displayName) {
  const mailOptions = {
    from: 'dotafreelancer@gmail.com',
    to: email,
  };

  // The user subscribed to the newsletter.
  mailOptions.subject = `Welcome to ${APP_NAME}!`;
  mailOptions.text = `Hey ${displayName || ''}! Welcome to ${APP_NAME}. I hope you will enjoy our service.`;
  return mailTransport.sendMail(mailOptions).then(() => {
    return console.log('New welcome email sent to:', email);
  });
}

const deleteUser = functions.firestore
  .document('/manager/{value}').onUpdate((snap, context) => {
    const data = snap.data.data();
    if(data.deleted) {
        let uid = data.uid;
        admin.auth().deleteUser(uid)
          .then(function () {
            console.log("Successfully deleted user");
          })
          .catch(function (error) {
            console.log("Error deleting user:", error);
          });
    }
  });

module.exports = {
  sendNotification
}
